<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{KAKAO_JAVASCRIPT_KEY}}&autoload=false&libraries=services"></script>
  <style>
    html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // WebView → RN 로그 브릿지 (간소화)
    (function(){
      if (window.ReactNativeWebView) {
        const log = (tag, data) => {
          try { window.ReactNativeWebView.postMessage(tag + ': ' + JSON.stringify(data)); }
          catch(e){ window.ReactNativeWebView.postMessage(tag + ': ' + String(data)); }
        };
        window._rnlog = log;
        log('[WV] Map initialized', { origin: window.location.origin });
      }
    })();

    // === JS 쪽 한국 범위 가드 ===
    function isKorea(lat, lng) {
      return lat >= 33 && lat <= 39 && lng >= 124 && lng <= 132;
    }

    // URL 파라미터에서 초기 좌표 읽기
    const urlParams = new URLSearchParams(window.location.search);
    const INIT_LAT = parseFloat(urlParams.get('lat')) || 37.5665;
    const INIT_LNG = parseFloat(urlParams.get('lng')) || 126.978;
    const SHOW_CENTER_MARKER = urlParams.get('showCenter') !== 'false';

    // 전역 map, markers 참조 - window 객체에 할당
    window.map = null;
    window.placeMarker = null;
    window.currentLocationMarker = null;
    window.placeMarkers = []; // 장소 마커들 배열

    window.makeSafeLatLng = function makeSafeLatLng(lat, lng) {
      if (Number.isFinite(lat) && Number.isFinite(lng)) {
        if (!isKorea(lat, lng)) {
          return new kakao.maps.LatLng(37.5665, 126.9780);
        }
        return new kakao.maps.LatLng(lat, lng);
      }
      return new kakao.maps.LatLng(37.5665, 126.9780);
    }

    // 카테고리별 마커 이미지 생성 함수 - window 객체에 할당
    window.createCategoryMarkerImage = function createCategoryMarkerImage(category, isSelected = false) {
      let svgContent = '';
      
      // 특별한 경우: map-marker 사용
      if (category === 'map-marker' || category === 'default-marker') {
        svgContent = `<svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
<g opacity="0.16" filter="url(#filter0_f_5713_80256)">
<ellipse cx="30" cy="53.75" rx="7.5" ry="2.5" fill="#171719"/>
</g>
<path d="M30 6.02783C40.1743 6.02783 49.375 13.8171 49.375 25.9028C49.375 29.7162 47.9056 33.9232 44.8896 38.5396C41.8747 43.1545 37.337 48.1436 31.2617 53.5093C30.5481 54.1259 29.4774 54.1257 28.7637 53.5093C22.6758 48.1435 18.1313 43.1535 15.1133 38.5386C12.0945 33.9225 10.625 29.7161 10.625 25.9028C10.625 13.8171 19.8257 6.02783 30 6.02783ZM30 19.7778C26.9048 19.7778 24.375 22.3077 24.375 25.4028C24.375 28.498 26.9048 31.0278 30 31.0278C33.0952 31.0278 35.625 28.498 35.625 25.4028C35.625 22.3077 33.0952 19.7778 30 19.7778Z" fill="#5977D8" stroke="white" stroke-width="1.25"/>
<defs>
<filter id="filter0_f_5713_80256" x="20" y="48.75" width="20" height="10" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
<feGaussianBlur stdDeviation="1.25" result="effect1_foregroundBlur_5713_80256"/>
</filter>
</defs>
</svg>`;
      }
      // 카페 카테고리 마커 SVG (CE7)
      else if (category === 'CE7') {
        svgContent = `<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_2414_43289)">
<g opacity="0.16" filter="url(#filter0_f_2414_43289)">
<ellipse cx="20" cy="36.875" rx="5" ry="1.875" fill="#171719"/>
</g>
<g filter="url(#filter1_d_2414_43289)">
<path fill-rule="evenodd" clip-rule="evenodd" d="M20 2.14307C28.2843 2.14307 35 8.70529 35 16.8002C35 23.0069 31.0519 28.3126 25.4757 30.4501L20.8542 36.0105C20.7578 36.1397 20.6299 36.2451 20.4812 36.318C20.3325 36.3908 20.1674 36.4288 19.9998 36.4288C19.8323 36.4288 19.6672 36.3908 19.5185 36.318C19.3698 36.2451 19.2418 36.1397 19.1455 36.0105L14.5238 30.4499C8.94793 28.3123 5 23.0068 5 16.8002C5 8.70529 11.7157 2.14307 20 2.14307Z" fill="white"/>
</g>
<path opacity="0.16" d="M32.5 16.875C32.5 9.97144 26.9036 4.375 20 4.375C13.0964 4.375 7.5 9.97144 7.5 16.875C7.5 23.7786 13.0964 29.375 20 29.375C26.9036 29.375 32.5 23.7786 32.5 16.875Z" fill="#F55A00"/>
<path d="M25 13.875H14C13.8674 13.875 13.7402 13.9277 13.6464 14.0214C13.5527 14.1152 13.5 14.2424 13.5 14.375V17.375C13.5015 18.2262 13.6835 19.0675 14.0341 19.8432C14.3847 20.6189 14.8958 21.3114 15.5338 21.875H14C13.8674 21.875 13.7402 21.9277 13.6464 22.0214C13.5527 22.1152 13.5 22.2424 13.5 22.375C13.5 22.5076 13.5527 22.6348 13.6464 22.7286C13.7402 22.8223 13.8674 22.875 14 22.875H25C25.1326 22.875 25.2598 22.8223 25.3536 22.7286C25.4473 22.6348 25.5 22.5076 25.5 22.375C25.5 22.2424 25.4473 22.1152 25.3536 22.0214C25.2598 21.9277 25.1326 21.875 25 21.875H23.4663C24.232 21.1963 24.8127 20.3341 25.1538 19.3694C25.7888 19.3302 26.3851 19.0504 26.821 18.587C27.2569 18.1235 27.4998 17.5113 27.5 16.875V16.375C27.5 15.712 27.2366 15.0761 26.7678 14.6072C26.2989 14.1384 25.663 13.875 25 13.875ZM26.5 16.875C26.4998 17.1985 26.395 17.5132 26.2013 17.7723C26.0075 18.0314 25.7352 18.2208 25.425 18.3125C25.4745 18.0025 25.4996 17.689 25.5 17.375V14.9612C25.7924 15.0646 26.0455 15.2561 26.2246 15.5092C26.4037 15.7624 26.4999 16.0649 26.5 16.375V16.875ZM19 12.375V10.375C19 10.2424 19.0527 10.1152 19.1464 10.0214C19.2402 9.92768 19.3674 9.875 19.5 9.875C19.6326 9.875 19.7598 9.92768 19.8536 10.0214C19.9473 10.1152 20 10.2424 20 10.375V12.375C20 12.5076 19.9473 12.6348 19.8536 12.7286C19.7598 12.8223 19.6326 12.875 19.5 12.875C19.3674 12.875 19.2402 12.8223 19.1464 12.7286C19.0527 12.6348 19 12.5076 19 12.375ZM21 12.375V10.375C21 10.2424 21.0527 10.1152 21.1464 10.0214C21.2402 9.92768 21.3674 9.875 21.5 9.875C21.6326 9.875 21.7598 9.92768 21.8536 10.0214C21.9473 10.1152 22 10.2424 22 10.375V12.375C22 12.5076 21.9473 12.6348 21.8536 12.7286C21.7598 12.8223 21.6326 12.875 21.5 12.875C21.3674 12.875 21.2402 12.8223 21.1464 12.7286C21.0527 12.6348 21 12.5076 21 12.375ZM17 12.375V10.375C17 10.2424 17.0527 10.1152 17.1464 10.0214C17.2402 9.92768 17.3674 9.875 17.5 9.875C17.6326 9.875 17.7598 9.92768 17.8536 10.0214C17.9473 10.1152 18 10.2424 18 10.375V12.375C18 12.5076 17.9473 12.6348 17.8536 12.7286C17.7598 12.8223 17.6326 12.875 17.5 12.875C17.3674 12.875 17.2402 12.8223 17.1464 12.7286C17.0527 12.6348 17 12.5076 17 12.375Z" fill="#F55A00"/>
</g>
<defs>
<filter id="filter0_f_2414_43289" x="13" y="33" width="14" height="7.75" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
<feGaussianBlur stdDeviation="1" result="effect1_foregroundBlur_2414_43289"/>
</filter>
<filter id="filter1_d_2414_43289" x="1.25" y="-0.981934" width="37.5" height="41.7856" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="0.625"/>
<feGaussianBlur stdDeviation="1.875"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"/>
<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2414_43289"/>
<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2414_43289" result="shape"/>
</filter>
<clipPath id="clip0_2414_43289">
<rect width="40" height="40" fill="white"/>
</clipPath>
</defs>
</svg>`;
      }
      // 음식점 카테고리 마커 SVG (FD6)
      else if (category === 'FD6') {
        svgContent = `<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_2414_43480)">
<g opacity="0.16" filter="url(#filter0_f_2414_43480)">
<ellipse cx="20" cy="36.875" rx="5" ry="1.875" fill="#171719"/>
</g>
<g filter="url(#filter1_d_2414_43480)">
<path fill-rule="evenodd" clip-rule="evenodd" d="M20 2.14307C28.2843 2.14307 35 8.70529 35 16.8002C35 23.0069 31.0519 28.3126 25.4757 30.4501L20.8542 36.0105C20.7578 36.1397 20.6299 36.2451 20.4812 36.318C20.3325 36.3908 20.1674 36.4288 19.9998 36.4288C19.8323 36.4288 19.6672 36.3908 19.5185 36.318C19.3698 36.2451 19.2418 36.1397 19.1455 36.0105L14.5238 30.4499C8.94793 28.3123 5 23.0068 5 16.8002C5 8.70529 11.7157 2.14307 20 2.14307Z" fill="white"/>
</g>
<path opacity="0.16" d="M32.5 16.875C32.5 9.97144 26.9036 4.375 20 4.375C13.0964 4.375 7.5 9.97144 7.5 16.875C7.5 23.7786 13.0964 29.375 20 29.375C26.9036 29.375 32.5 23.7786 32.5 16.875Z" fill="#D17600"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M17.8798 15.417C18.7619 14.9829 19.3819 13.9557 19.3819 12.7575C19.3819 11.1669 18.2891 9.87736 16.941 9.87736C15.5929 9.87736 14.5 11.1669 14.5 12.7575C14.5 13.9557 15.12 14.9829 16.0021 15.417V23.2126C16.0021 23.4671 16.2263 23.6734 16.5028 23.6734H17.3791C17.6556 23.6734 17.8798 23.4671 17.8798 23.2126V15.417Z" fill="#FCCD40"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M22.7461 10.1478C22.7461 10.0103 22.8523 9.89352 23.0014 9.88452C23.0154 9.88367 23.0295 9.88289 23.0434 9.88219V9.87737C23.0689 9.87737 23.0981 9.87783 23.1294 9.87875C23.1608 9.87783 23.19 9.87737 23.2155 9.87737V9.88219C23.2294 9.88289 23.2435 9.88367 23.2575 9.88452C23.4066 9.89352 23.5128 10.0103 23.5128 10.1478V12.5703C23.5128 12.7692 23.6879 12.9303 23.904 12.9303C24.12 12.9303 24.2952 12.7692 24.2952 12.5703V10.1638C24.2952 10.0047 24.4367 9.85505 24.6079 9.87718C24.7242 9.89222 24.802 9.94873 24.9211 10.1366C25.2497 10.6551 25.5 11.8017 25.5 12.4839C25.5 13.6404 24.9141 14.5996 24.0761 15.0371V23.2126C24.0761 23.4671 23.8519 23.6734 23.5754 23.6734H22.6991C22.4226 23.6734 22.1984 23.4671 22.1984 23.2126V15.0452C21.3521 14.6115 20.7589 13.6476 20.7589 12.4839C20.7589 11.8017 21.0092 10.6551 21.3378 10.1366C21.4569 9.94873 21.5347 9.89222 21.651 9.87718C21.8222 9.85505 21.9637 10.0047 21.9637 10.1638V12.5703C21.9637 12.7692 22.1389 12.9303 22.3549 12.9303C22.5709 12.9303 22.7461 12.7692 22.7461 12.5703V10.1478Z" fill="#FCCD40"/>
<path d="M15.7205 17.7114C15.7205 17.5842 15.8326 17.481 15.9708 17.481H17.9111C18.0494 17.481 18.1615 17.5842 18.1615 17.7114V23.6446C18.1615 23.7718 18.0494 23.875 17.9111 23.875H15.9708C15.8326 23.875 15.7205 23.7718 15.7205 23.6446V17.7114Z" fill="#B79632"/>
<path d="M21.9168 17.7114C21.9168 17.5842 22.0289 17.481 22.1671 17.481H24.1074C24.2457 17.481 24.3578 17.5842 24.3578 17.7114V23.6446C24.3578 23.7718 24.2457 23.875 24.1074 23.875H22.1671C22.0289 23.875 21.9168 23.7718 21.9168 23.6446V17.7114Z" fill="#B79632"/>
</g>
<defs>
<filter id="filter0_f_2414_43480" x="13" y="33" width="14" height="7.75" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
<feGaussianBlur stdDeviation="1" result="effect1_foregroundBlur_2414_43480"/>
</filter>
<filter id="filter1_d_2414_43480" x="1.25" y="-0.981934" width="37.5" height="41.7856" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="0.625"/>
<feGaussianBlur stdDeviation="1.875"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"/>
<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2414_43480"/>
<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2414_43480" result="shape"/>
</filter>
<clipPath id="clip0_2414_43480">
<rect width="40" height="40" fill="white"/>
</clipPath>
</defs>
</svg>`;
      }
      // 관광지 카테고리 마커 SVG (AT4)
      else if (category === 'AT4') {
          svgContent = `<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_3969_62335)">
<g opacity="0.16" filter="url(#filter0_f_3969_62335)">
<ellipse cx="20" cy="36.875" rx="5" ry="1.875" fill="#171719"/>
</g>
<g filter="url(#filter1_d_3969_62335)">
<path fill-rule="evenodd" clip-rule="evenodd" d="M20 2.14307C28.2843 2.14307 35 8.70529 35 16.8002C35 23.0069 31.0519 28.3126 25.4757 30.4501L20.8542 36.0105C20.7578 36.1397 20.6299 36.2451 20.4812 36.318C20.3325 36.3908 20.1674 36.4288 19.9998 36.4288C19.8323 36.4288 19.6672 36.3908 19.5185 36.318C19.3698 36.2451 19.2418 36.1397 19.1455 36.0105L14.5238 30.4499C8.94793 28.3123 5 23.0068 5 16.8002C5 8.70529 11.7157 2.14307 20 2.14307Z" fill="white"/>
</g>
<path opacity="0.16" d="M32.5 16.875C32.5 9.97144 26.9036 4.375 20 4.375C13.0964 4.375 7.5 9.97144 7.5 16.875C7.5 23.7786 13.0964 29.375 20 29.375C26.9036 29.375 32.5 23.7786 32.5 16.875Z" fill="#005EEB"/>
<path d="M25 12.375H23.2675L22.4156 11.0975C22.37 11.0291 22.3082 10.973 22.2357 10.9342C22.1632 10.8954 22.0822 10.875 22 10.875H18C17.9178 10.875 17.8368 10.8954 17.7643 10.9342C17.6918 10.973 17.63 11.0291 17.5844 11.0975L16.7319 12.375H15C14.6022 12.375 14.2206 12.533 13.9393 12.8143C13.658 13.0956 13.5 13.4772 13.5 13.875V20.875C13.5 21.2728 13.658 21.6544 13.9393 21.9357C14.2206 22.217 14.6022 22.375 15 22.375H25C25.3978 22.375 25.7794 22.217 26.0607 21.9357C26.342 21.6544 26.5 21.2728 26.5 20.875V13.875C26.5 13.4772 26.342 13.0956 26.0607 12.8143C25.7794 12.533 25.3978 12.375 25 12.375ZM22.25 17.125C22.25 17.57 22.118 18.005 21.8708 18.375C21.6236 18.745 21.2722 19.0334 20.861 19.2037C20.4499 19.374 19.9975 19.4186 19.561 19.3318C19.1246 19.245 18.7237 19.0307 18.409 18.716C18.0943 18.4013 17.88 18.0004 17.7932 17.564C17.7064 17.1275 17.751 16.6751 17.9213 16.264C18.0916 15.8528 18.38 15.5014 18.75 15.2542C19.12 15.007 19.555 14.875 20 14.875C20.5967 14.875 21.169 15.1121 21.591 15.534C22.0129 15.956 22.25 16.5283 22.25 17.125Z" fill="#005EEB"/>
</g>
<defs>
<filter id="filter0_f_3969_62335" x="13" y="33" width="14" height="7.75" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
<feGaussianBlur stdDeviation="1" result="effect1_foregroundBlur_3969_62335"/>
</filter>
<filter id="filter1_d_3969_62335" x="1.25" y="-0.981934" width="37.5" height="41.7856" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="0.625"/>
<feGaussianBlur stdDeviation="1.875"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"/>
<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_3969_62335"/>
<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_3969_62335" result="shape"/>
</filter>
<clipPath id="clip0_3969_62335">
<rect width="40" height="40" fill="white"/>
</clipPath>
</defs>
</svg>`;
      }
      // 기본 마커 (기타 카테고리용)
      else {
        svgContent = `<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_4577_81296)">
<g opacity="0.16" filter="url(#filter0_f_4577_81296)">
<ellipse cx="20" cy="36.875" rx="5" ry="1.875" fill="#E96D2B"/>
</g>
<g filter="url(#filter1_d_4577_81296)">
<path fill-rule="evenodd" clip-rule="evenodd" d="M20 2.14307C28.2843 2.14307 35 8.70529 35 16.8002C35 23.0069 31.0519 28.3126 25.4757 30.4501L20.8542 36.0105C20.7578 36.1397 20.6299 36.2451 20.4812 36.318C20.3325 36.3908 20.1674 36.4288 19.9998 36.4288C19.8323 36.4288 19.6672 36.3908 19.5185 36.318C19.3698 36.2451 19.2418 36.1397 19.1455 36.0105L14.5238 30.4499C8.94793 28.3123 5 23.0068 5 16.8002C5 8.70529 11.7157 2.14307 20 2.14307Z" fill="white"/>
</g>
<path opacity="0.16" d="M32.5 16.875C32.5 9.97144 26.9036 4.375 20 4.375C13.0964 4.375 7.5 9.97144 7.5 16.875C7.5 23.7786 13.0964 29.375 20 29.375C26.9036 29.375 32.5 23.7786 32.5 16.875Z" fill="#E96D2B"/>
<path d="M26.6574 16.0236L23.8387 18.4836L24.6831 22.1461C24.7277 22.3376 24.715 22.538 24.6464 22.7222C24.5778 22.9065 24.4564 23.0664 24.2974 23.1821C24.1384 23.2977 23.9489 23.364 23.7525 23.3725C23.556 23.381 23.3615 23.3314 23.1931 23.2299L19.9987 21.2924L16.8112 23.2299C16.6428 23.3314 16.4482 23.381 16.2518 23.3725C16.0554 23.364 15.8658 23.2977 15.7068 23.1821C15.5478 23.0664 15.4264 22.9065 15.3578 22.7222C15.2893 22.538 15.2765 22.3376 15.3212 22.1461L16.1643 18.4874L13.3449 16.0236C13.1958 15.895 13.088 15.7252 13.035 15.5356C12.982 15.3459 12.9861 15.1449 13.0469 14.9576C13.1077 14.7703 13.2225 14.6051 13.3768 14.4828C13.5311 14.3604 13.7181 14.2864 13.9143 14.2699L17.6306 13.948L19.0812 10.488C19.1569 10.3064 19.2847 10.1514 19.4484 10.0423C19.6121 9.93321 19.8045 9.875 20.0012 9.875C20.1979 9.875 20.3902 9.93321 20.5539 10.0423C20.7177 10.1514 20.8454 10.3064 20.9212 10.488L22.3762 13.948L26.0912 14.2699C26.2874 14.2864 26.4744 14.3604 26.6287 14.4828C26.783 14.6051 26.8978 14.7703 26.9586 14.9576C27.0194 15.1449 27.0235 15.3459 26.9705 15.5356C26.9175 15.7252 26.8097 15.895 26.6606 16.0236H26.6574Z" fill="#E96D2B"/>
</g>
<defs>
<filter id="filter0_f_4577_81296" x="13" y="33" width="14" height="7.75" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
<feGaussianBlur stdDeviation="1" result="effect1_foregroundBlur_4577_81296"/>
</filter>
<filter id="filter1_d_4577_81296" x="1.25" y="-0.981934" width="37.5" height="41.7856" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="0.625"/>
<feGaussianBlur stdDeviation="1.875"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"/>
<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_4577_81296"/>
<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_4577_81296" result="shape"/>
</filter>
<clipPath id="clip0_4577_81296">
<rect width="40" height="40" fill="white"/>
</clipPath>
</defs>
</svg>`;
      }
      
      const svgUrl = 'data:image/svg+xml;base64,' + btoa(svgContent);
      
      // 기본 크기
      const baseWidth = 40;
      const baseHeight = 40;

      // 선택된 마커는 2배 크기
      const finalWidth = isSelected ? baseWidth * 2 : baseWidth;
      const finalHeight = isSelected ? baseHeight * 2 : baseHeight;
      
      const size = new kakao.maps.Size(finalWidth, finalHeight);
      return new kakao.maps.MarkerImage(svgUrl, size);
    }

    // 현위치 마커 이미지 생성 함수
    window.createCurrentLocationMarker = function createCurrentLocationMarker() {
      const svgContent = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<g filter="url(#filter0_d_1575_19092)">
<circle cx="12" cy="10" r="8" fill="#FF4242"/>
<circle cx="12" cy="10" r="7" stroke="white" stroke-width="2"/>
</g>
<defs>
<filter id="filter0_d_1575_19092" x="0" y="0" width="24" height="24" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="2"/>
<feGaussianBlur stdDeviation="2"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0.0901961 0 0 0 0 0.0901961 0 0 0 0 0.0980392 0 0 0 0.12 0"/>
<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_1575_19092"/>
<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_1575_19092" result="shape"/>
</filter>
</defs>
</svg>`;
      
      const svgUrl = 'data:image/svg+xml;base64,' + btoa(svgContent);
      const imageSize = new kakao.maps.Size(24, 24);
      const imageOption = {offset: new kakao.maps.Point(12, 12)};
      
      return new kakao.maps.MarkerImage(svgUrl, imageSize, imageOption);
    }

    // 장소 마커들 업데이트 함수
    window.updatePlaceMarkers = function updatePlaceMarkers(markers) {
      window._rnlog && _rnlog('[WV] Updating markers', { count: markers.length });
      
      // 기존 장소 마커들 제거
      window.placeMarkers.forEach(marker => marker.setMap(null));
      window.placeMarkers = [];
      
      // 새 마커들 생성 및 추가
      markers.forEach((markerData, index) => {
        try {
          const position = window.makeSafeLatLng(markerData.latitude, markerData.longitude);
          const markerImage = window.createCategoryMarkerImage(markerData.categoryCode, markerData.isSelected);
          
          const marker = new kakao.maps.Marker({
            position: position,
            image: markerImage
          });
          
          // 마커 클릭 이벤트 리스너 추가
          kakao.maps.event.addListener(marker, 'click', function() {
            if (window.ReactNativeWebView) {
              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'markerClick',
                markerId: markerData.kakaoId
              }));
            }
          });
          
          marker.setMap(window.map);
          window.placeMarkers.push(marker);
        } catch (e) {
          window._rnlog && _rnlog(`[WV] Marker ${index + 1} creation failed`, e.message);
        }
      });
      
      window._rnlog && _rnlog('[WV] Markers updated', { created: window.placeMarkers.length });
    }

    // 바텀시트 높이를 고려한 자동 줌 조정 함수
    window.adjustMapBounds = function adjustMapBounds(bottomSheetHeight) {
      if (!window.map || window.placeMarkers.length === 0) return;
      
      try {
        // 마커 좌표들 로그 출력 (디버깅용)
        const markerPositions = window.placeMarkers.map((marker, index) => {
          const pos = marker.getPosition();
          return { index, lat: pos.getLat(), lng: pos.getLng() };
        });
        window._rnlog && _rnlog('[WV] Marker positions', markerPositions);
        
        // 모든 마커의 위치를 포함하는 bounds 계산
        const bounds = new kakao.maps.LatLngBounds();
        window.placeMarkers.forEach(marker => {
          bounds.extend(marker.getPosition());
        });
        
        // bounds 정보 로그 출력
        const sw = bounds.getSouthWest();
        const ne = bounds.getNorthEast();
        window._rnlog && _rnlog('[WV] Calculated bounds', {
          southwest: { lat: sw.getLat(), lng: sw.getLng() },
          northeast: { lat: ne.getLat(), lng: ne.getLng() }
        });
        
        // 바텀시트 높이를 고려한 여백 계산 - DOM 요소에서 직접 가져오기
        const mapContainer = document.getElementById('map');
        const mapHeight = mapContainer.clientHeight;
        const mapWidth = mapContainer.clientWidth;
        const bottomMargin = Math.floor(mapHeight * bottomSheetHeight);
        
        // 마커들을 더 중앙에 위치시키기 위해 상단 여백도 추가
        const topMargin = Math.floor(bottomMargin * 0.3); // 바텀 마진의 30% 정도를 상단에도 적용
        
        window._rnlog && _rnlog('[WV] Margins calculated', {
          mapHeight, bottomMargin, topMargin, bottomSheetHeight
        });
        
        // bounds에 여백 추가하여 setBounds 실행 (여백을 줄여서 더 확대, 상하 균형 조정)
        window.map.setBounds(bounds, bottomMargin + 20, 20, topMargin + 20, 20); // bottom, left, top, right
        
        // setBounds 후 줌 레벨 확인 및 스마트 조정
        setTimeout(() => {
          const currentLevel = window.map.getLevel();
          const center = window.map.getCenter();
          
          window._rnlog && _rnlog('[WV] After setBounds', {
            zoomLevel: currentLevel,
            center: { lat: center.getLat(), lng: center.getLng() },
            markerCount: window.placeMarkers.length
          });
          
          // 마커 개수에 따른 스마트 줌 레벨 제한
          if (window.placeMarkers.length === 2) {
            // 2개 마커의 경우: 너무 멀리 줌아웃되지 않도록 제한 (더 관대하게)
            if (currentLevel > 9) {
              window.map.setLevel(9);
              window._rnlog && _rnlog('[WV] 2개 마커 줌 레벨 조정', { 
                beforeLevel: currentLevel, 
                afterLevel: 9,
                reason: '2개 마커 최적화'
              });
            }
          } else if (window.placeMarkers.length > 2) {
            // 3개 이상의 경우: 좀 더 엄격한 제한
            if (currentLevel > 8) {
              window.map.setLevel(8);
              window._rnlog && _rnlog('[WV] 다중 마커 줌 레벨 조정', { 
                beforeLevel: currentLevel, 
                afterLevel: 8,
                reason: '다중 마커 최적화'
              });
            }
          }
        }, 50);
        
        window._rnlog && _rnlog('[WV] Auto bounds adjusted', { height: bottomSheetHeight, markers: window.placeMarkers.length });
      } catch (e) {
        window._rnlog && _rnlog('[WV] Auto bounds error', e.message);
      }
    }

    // 렌더링 추적을 위한 전역 카운터
    window.renderCount = {
      mapInit: 0,
      centerChanged: 0,
      tilesLoaded: 0,
      markerUpdate: 0,
      boundsAdjust: 0
    };

    kakao.maps.load(function() {
      try {
        window.renderCount.mapInit++;
        window._rnlog && _rnlog('[WV] Map initializing', { 
          count: window.renderCount.mapInit,
          coords: { lat: INIT_LAT, lng: INIT_LNG }
        });

        const mapContainer = document.getElementById('map');
        const center = window.makeSafeLatLng(INIT_LAT, INIT_LNG);
        const mapOption = { center, level: 3 };

        window.map = new kakao.maps.Map(mapContainer, mapOption);
        
        // showCenterMarker가 true일 때만 중심점 마커 생성
        if (SHOW_CENTER_MARKER) {
          const customMarkerImage = window.createCustomMarkerImage(false);
          window.placeMarker = new kakao.maps.Marker({ 
            position: center,
            image: customMarkerImage
          });
          window.placeMarker.setMap(window.map);
        }

        // 지도 중심 좌표 변경 이벤트 리스너 (성능 모니터링 포함)
        kakao.maps.event.addListener(window.map, 'center_changed', function() {
          window.renderCount.centerChanged++;
          const center = window.map.getCenter();
          const lat = center.getLat();
          const lng = center.getLng();
          
          // React Native로 중심 좌표 변경 알림
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({
              type: 'centerChanged',
              lat: lat,
              lng: lng
            }));
          }
        });

        // 타일 로딩 완료 이벤트 (재렌더링 모니터링)
        kakao.maps.event.addListener(window.map, 'tilesloaded', function() {
          window.renderCount.tilesLoaded++;
          window._rnlog && _rnlog('[WV] Tiles loaded', { count: window.renderCount.tilesLoaded });
        });

        setTimeout(() => {
          window.map.relayout();
        }, 100);

        window._rnlog && _rnlog('[WV] Map ready', { 
          initCount: window.renderCount.mapInit
        });

      } catch (e) {
        window._rnlog && _rnlog('[WV] Map init error', e.message);
      }
    });

    // RN → WV 메시지 핸들러
    window.addEventListener('message', (evt) => {
      try {
        const msg = JSON.parse(evt.data);
        
        // 장소 위치 변경
        if (msg?.type === 'setCenter' && Number.isFinite(msg?.lat) && Number.isFinite(msg?.lng) && window.map) {
          const c = window.makeSafeLatLng(msg.lat, msg.lng);
          window.map.setCenter(c);
          
          // 기존 장소 마커 제거 후 새로 생성
          if (window.placeMarker) window.placeMarker.setMap(null);
          const customMarkerImage = window.createCustomMarkerImage(false);
          window.placeMarker = new kakao.maps.Marker({ 
            position: c,
            image: customMarkerImage
          });
          window.placeMarker.setMap(window.map);
        }
        
        // 현재 위치 마커 표시 및 지도 중심 이동 (애니메이션)
        if (msg?.type === 'setCurrentLocation' && Number.isFinite(msg?.lat) && Number.isFinite(msg?.lng) && window.map) {
          const c = window.makeSafeLatLng(msg.lat, msg.lng);
          
          // 부드러운 애니메이션으로 지도 중심 이동
          window.map.panTo(c);
          
          // 기존 현재 위치 마커 제거 후 새로 생성
          if (window.currentLocationMarker) {
            window.currentLocationMarker.setMap(null);
            window.currentLocationMarker = null;
          }
          
          // 빨간색 현위치 마커 생성
          const currentLocationMarkerImage = window.createCurrentLocationMarker();
          window.currentLocationMarker = new kakao.maps.Marker({ 
            position: c,
            image: currentLocationMarkerImage,
            title: '현재 위치',
            zIndex: 1000 // 다른 마커보다 위에 표시
          });
          window.currentLocationMarker.setMap(window.map);
          
          window._rnlog && _rnlog('[WV] 현위치 마커 생성 및 지도 이동', { lat: msg.lat, lng: msg.lng });
        }

        // 현위치 마커 업데이트 (지도 중심 이동 없이)
        if (msg?.type === 'updateCurrentLocation' && Number.isFinite(msg?.lat) && Number.isFinite(msg?.lng) && window.map) {
          window.updateCurrentLocationMarker(msg.lat, msg.lng);
        }

        // 지도 줌 레벨 설정
        if (msg?.type === 'setZoomLevel' && Number.isFinite(msg?.level) && window.map) {
          window.map.setLevel(msg.level);
        }

        // 지도 중심 이동 (애니메이션 포함)
        if (msg?.type === 'panToLocation' && Number.isFinite(msg?.lat) && Number.isFinite(msg?.lng) && window.map) {
          const position = window.makeSafeLatLng(msg.lat, msg.lng);
          window.map.panTo(position);
        }

        // 장소 마커들 업데이트
        if (msg?.type === 'updateMarkers' && msg?.markers) {
          window.renderCount.markerUpdate++;
          window.updatePlaceMarkers(msg.markers);
          
          // 바텀시트 높이 정보가 있으면 자동 줌 조정 실행
          if (msg.bottomSheetHeight) {
            setTimeout(() => {
              if (window.adjustMapBounds) {
                window.renderCount.boundsAdjust++;
                window.adjustMapBounds(msg.bottomSheetHeight);
              }
            }, 500);
          }
        }

        // 바텀시트 높이 변경에 따른 자동 줌 조정
        if (msg?.type === 'adjustBounds' && msg?.bottomSheetHeight) {
          setTimeout(() => {
            if (window.adjustMapBounds) {
              window.renderCount.boundsAdjust++;
              window.adjustMapBounds(msg.bottomSheetHeight);
            }
          }, 300);
        }

        // 지도 중심 설정 + 선택적 중심 마커 표시
        if (msg?.type === 'setMapCenterWithMarker' && Number.isFinite(msg?.lat) && Number.isFinite(msg?.lng) && window.map) {
          try {
            const c = window.makeSafeLatLng(msg.lat, msg.lng);
            window.map.setCenter(c);
            
            // showCenterMarker가 true일 때만 중심점 마커 생성
            if (msg.showCenterMarker) {
              if (window.placeMarker) window.placeMarker.setMap(null);
              const customMarkerImage = window.createCustomMarkerImage(false);
              window.placeMarker = new kakao.maps.Marker({ 
                position: c,
                image: customMarkerImage
              });
              window.placeMarker.setMap(window.map);
            } else {
              // 중심 마커 숨김
              if (window.placeMarker) {
                window.placeMarker.setMap(null);
              }
            }
          } catch(e) {
            window._rnlog && _rnlog('[WV] setMapCenterWithMarker error', e.message);
          }
        }

        // 장소 마커 업데이트 + 자동 줌 조정
        if (msg?.type === 'updatePlaceMarkersWithAutoZoom' && Array.isArray(msg?.markers) && window.map) {
          try {
            window.renderCount.markerUpdate++;
            window._rnlog && _rnlog('[WV] Updating markers with auto zoom', { 
              count: msg.markers.length,
              updateCount: window.renderCount.markerUpdate
            });

            // 장소 마커 업데이트
            if (window.updatePlaceMarkers) {
              window.updatePlaceMarkers(msg.markers);
            }
            
            // 마커 업데이트 후 자동 줌 조정 실행
            if (msg.markers.length > 0 && msg.bottomSheetHeight !== undefined) {
              setTimeout(() => {
                if (window.adjustMapBounds) {
                  window.renderCount.boundsAdjust++;
                  window.adjustMapBounds(msg.bottomSheetHeight);
                }
              }, 500);
            }
          } catch(e) {
            window._rnlog && _rnlog('[WV] updatePlaceMarkersWithAutoZoom error', e.message);
          }
        }

        // 바텀시트 높이 조정 + 센터 보정
        if (msg?.type === 'adjustBottomSheetWithCenterCorrection' && window.map) {
          try {
            const bottomSheetHeight = msg.bottomSheetHeight;
            const previousHeight = msg.previousHeight;
            const shouldApplyCenterCorrection = msg.shouldApplyCenterCorrection;
            const markerCount = msg.markerCount || 0;
            
            const screenHeight = window.innerHeight;
            
            // 기준 센터 설정 (45% 일 때의 센터)
            if (Math.abs(bottomSheetHeight - 0.45) < 0.01) {
              window.baseCenter = window.map.getCenter();
            }
            
            // 45% ↔ 최소 높이 간 이동에서만 센터 보정 적용
            if (shouldApplyCenterCorrection && window.baseCenter) {
              const currentMapCenter = window.map.getCenter();
              
              if (Math.abs(bottomSheetHeight - 0.2) < 0.01) {
                // 45% → 20%: 지도 높이 증가에 따른 센터 보정
                const mapHeightAt45 = screenHeight * (1 - 0.45);
                const mapHeightAt20 = screenHeight * (1 - 0.2);
                const heightIncrease = mapHeightAt20 - mapHeightAt45;
                const centerOffsetY = heightIncrease * 0.5;
                
                const projection = window.map.getProjection();
                const currentPoint = projection.pointFromCoords(currentMapCenter);
                const adjustedPoint = { x: currentPoint.x, y: currentPoint.y + centerOffsetY };
                const newCenter = projection.coordsFromPoint(adjustedPoint);
                window.map.panTo(newCenter);
                
              } else if (Math.abs(bottomSheetHeight - 0.45) < 0.01) {
                // 20% → 45%: 지도 높이 감소에 따른 센터 보정
                const mapHeightAt20 = screenHeight * (1 - 0.2);
                const mapHeightAt45 = screenHeight * (1 - 0.45);
                const heightDecrease = mapHeightAt20 - mapHeightAt45;
                const centerOffsetY = -heightDecrease * 0.5;
                
                const projection = window.map.getProjection();
                const currentPoint = projection.pointFromCoords(currentMapCenter);
                const adjustedPoint = { x: currentPoint.x, y: currentPoint.y + centerOffsetY };
                const newCenter = projection.coordsFromPoint(adjustedPoint);
                window.map.panTo(newCenter);
              }
            }
            
            // 장소 마커가 있을 때만 자동 줌 조정
            if (window.adjustMapBounds && markerCount > 0 && bottomSheetHeight < 0.75) {
              setTimeout(() => {
                window.renderCount.boundsAdjust++;
                window.adjustMapBounds(bottomSheetHeight);
              }, 300);
            }
          } catch(e) {
            window._rnlog && _rnlog('[WV] adjustBottomSheetWithCenterCorrection error', e.message);
          }
        }

        // 기준 센터 업데이트
        if (msg?.type === 'updateBaseCenter' && Number.isFinite(msg?.lat) && Number.isFinite(msg?.lng) && window.map) {
          try {
            window.baseCenter = new kakao.maps.LatLng(msg.lat, msg.lng);
          } catch(e) {
            window._rnlog && _rnlog('[WV] updateBaseCenter error', e.message);
          }
        }
        
        // 성능 모니터링 정보 출력 (5초마다)
        if (msg?.type === 'getPerformanceInfo') {
          window._rnlog && _rnlog('[WV] Performance Info', {
            renderCount: window.renderCount,
            totalRenders: Object.values(window.renderCount).reduce((a, b) => a + b, 0),
            mapExists: !!window.map,
            markersCount: window.placeMarkers ? window.placeMarkers.length : 0
          });
        }
      } catch(e) {
        window._rnlog && _rnlog('[WV] Message processing error', e.message);
      }
    });
  </script>
</body>
</html>